<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Labyrinthe ‚Äî Hardcore 40√ó40</title>
<style>
  :root{
    --bg:#050304;
    --wall:#0b0705;
    --floor:#2b2218;
    --player:#f6e6b2;
    --trap:#7b1420;
    --door:#4a2f10;
    --exit:#0b6b33;
    --text:#efe6c9;
    --accent:#b98a26;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#020202,var(--bg));font-family:Inter,system-ui,Arial;color:var(--text)}
  .wrap{max-width:1200px;margin:18px auto;padding:10px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 12px}
  h1{margin:0;font-size:20px;color:var(--accent)}
  p.lead{margin:6px 0 0 0;color:#d6c8a3;font-size:13px}

  .container { display:flex; gap:14px; padding:10px; align-items:flex-start; }
  .board-wrap { overflow:auto; border-radius:10px; background:rgba(0,0,0,0.35); padding:8px; border:1px solid rgba(255,255,255,0.03); }
  .grid {
    display:grid;
    grid-template-columns: repeat(40, 16px);
    grid-auto-rows: 16px;
    gap:1px;
    background:linear-gradient(180deg, rgba(0,0,0,0.03), transparent);
  }
  .cell { width:16px; height:16px; border-radius:2px; box-sizing:border-box; }
  .cell.wall { background:var(--wall); box-shadow: inset 0 0 4px rgba(0,0,0,0.7); }
  .cell.empty { background:var(--floor); }
  .cell.player { background:linear-gradient(180deg,var(--player), #d4af37); box-shadow:0 1px 3px rgba(0,0,0,0.6); }
  .cell.trap { background:var(--trap); }
  .cell.door { background:var(--door); }
  .cell.fakeexit { background:#08303a; opacity:0.9; }
  .cell.exit { background:linear-gradient(180deg,#0b6b33,#045c2b); border:2px solid rgba(185,138,38,0.12); }

  .controls {
    width:300px;
    min-width:260px;
    padding:12px;
    border-radius:10px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));
    border:1px solid rgba(255,255,255,0.03);
  }
  .controls h3{margin:0 0 8px 0;color:var(--accent)}
  .stat{margin:8px 0;font-size:13px}
  .btns {display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
  .ctl { padding:10px;border-radius:8px;background:#241b15;color:var(--text);text-align:center;cursor:pointer;border:1px solid rgba(255,255,255,0.02); user-select:none;}
  .small{font-size:12px;color:#cfc1a2;margin-top:10px}

  .legend { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .legend .item { font-size:12px; display:flex; gap:6px; align-items:center; }
  .swatch { width:14px;height:14px;border-radius:3px; display:inline-block; }

  .modal-back { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:200; }
  .modal { background:linear-gradient(180deg,#22160f,#0f0b08); padding:18px;border-radius:10px;border:2px solid rgba(185,138,38,0.18); width:360px; color:var(--text); text-align:center; }
  .modal h2{margin:6px 0 8px 0;color:var(--accent)}
  .modal p{font-size:13px;text-align:left;white-space:pre-wrap;}

  @media (max-width:980px){
    .container { flex-direction:column; align-items:center; }
    .controls { width:100%; max-width:560px; }
    .board-wrap{ max-width:100%; overflow:auto; }
  }

  .bump { animation: bumpAnim 120ms linear; }
  @keyframes bumpAnim {
    0%{ transform:translateX(0); } 25%{ transform:translateX(-6px);} 50%{ transform:translateX(6px);} 100%{ transform:translateX(0); }
  }

  .mobile-tip { display:none; margin-top:8px; font-size:12px; color:#d9cfa2; }
  @media (max-width:640px){ .mobile-tip{display:block} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Labyrinthe ‚Äî Niveau : Hardcore Ultime (40√ó40)</h1>
        <p class="lead">ZQSD / fl√®ches pour te d√©placer. Beaucoup de pi√®ges & portes. Bonne chance.</p>
      </div>
      <div class="small">Taille : 40√ó40 ‚Äî sauvegarde locale</div>
    </header>

    <div class="container">
      <div class="board-wrap" id="boardWrap" style="max-width:700px; max-height:560px;">
        <div id="grid" class="grid" aria-label="Labyrinthe"></div>
      </div>

      <aside class="controls">
        <h3>Contr√¥les</h3>
        <div class="stat">Touches: <strong>ZQSD</strong> ou <strong>fl√®ches</strong></div>
        <div class="btns">
          <div></div>
          <div class="ctl" id="upBtn">‚ñ≤</div>
          <div></div>
          <div class="ctl" id="leftBtn">‚óÄ</div>
          <div class="ctl" id="downBtn">‚ñº</div>
          <div class="ctl" id="rightBtn">‚ñ∂</div>
        </div>
        <div class="mobile-tip">Sur mobile, utilise les boutons. Tapote plusieurs fois pour avancer rapidement.</div>

        <div class="legend">
          <div class="item"><span class="swatch" style="background:var(--floor)"></span> Couloir</div>
          <div class="item"><span class="swatch" style="background:var(--wall)"></span> Mur</div>
          <div class="item"><span class="swatch" style="background:var(--trap)"></span> Pi√®ge (t√©l√©porte)</div>
          <div class="item"><span class="swatch" style="background:var(--door)"></span> Porte (mini-√©nigme)</div>
          <div class="item"><span class="swatch" style="background:var(--exit)"></span> Sortie</div>
        </div>

        <div style="margin-top:12px">
          <button class="ctl" id="resetBtn">R√©initialiser</button>
          <button class="ctl" id="homeBtn" style="margin-left:8px">Retour</button>
        </div>
      </aside>
    </div>
  </div>

  <div id="modalBackdrop" class="modal-back" aria-hidden="true">
    <div class="modal" id="modal"></div>
  </div>

<script>
(function(){
  const ROWS = 41; // internal odd-based grid for maze
  const COLS = 41;
  const DISPLAY_ROWS = 40;
  const DISPLAY_COLS = 40;
  const CELL_SIZE = 16;
  const STORAGE_KEY = "hardcore_maze_40_state";

  const gridEl = document.getElementById('grid');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modal = document.getElementById('modal');
  const upBtn = document.getElementById('upBtn');
  const downBtn = document.getElementById('downBtn');
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const resetBtn = document.getElementById('resetBtn');
  const homeBtn = document.getElementById('homeBtn');
  const boardWrap = document.getElementById('boardWrap');

  let grid=[], player={r:1,c:1}, displayOffsetR=1, displayOffsetC=1, solved=false;
  const doorPuzzles={};

  function initGrid(){ grid=Array.from({length:ROWS},()=>Array.from({length:COLS},()=>({type:'wall',el:null}))); }

  function generateMaze(){
    initGrid();
    const stack=[[1,1]]; grid[1][1].type='empty';
    const dirs=[[0,2],[0,-2],[2,0],[-2,0]];
    while(stack.length){
      const [r,c]=stack[stack.length-1];
      const neighbors=[];
      for(const [dr,dc] of dirs){
        const nr=r+dr,nc=c+dc;
        if(nr>0&&nr<ROWS-1&&nc>0&&nc<COLS-1&&grid[nr][nc].type==='wall') neighbors.push([nr,nc,dr,dc]);
      }
      if(neighbors.length===0){stack.pop();}
      else{
        const [nr,nc,dr,dc]=neighbors[Math.floor(Math.random()*neighbors.length)];
        grid[r+dr/2][c+dc/2].type='empty';
        grid[nr][nc].type='empty';
        stack.push([nr,nc]);
      }
    }
  }

  function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

  function scatterHazards(){
    for(const k in doorPuzzles) delete doorPuzzles[k];
    const candidates=[];
    for(let r=1;r<ROWS-1;r++) for(let c=1;c<COLS-1;c++){
      if(grid[r][c].type==='empty' && !(Math.abs(r-1)+Math.abs(c-1)<5)) candidates.push([r,c]);
    }
    shuffleArray(candidates);

    const trapCount=Math.max(30, Math.floor(candidates.length*0.04));
    for(let i=0;i<trapCount;i++){const [r,c]=candidates[i];grid[r][c].type='trap';}

    let doorPlaced=0,idxCand=trapCount;
    while(doorPlaced<8 && idxCand<candidates.length){
      const [r,c]=candidates[idxCand++];
      let ok=true;
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        const rr=r+dr,cc=c+dc;if(rr>0&&rr<ROWS&&cc>0&&cc<COLS) if(grid[rr][cc].type==='door'||grid[rr][cc].type==='trap') ok=false;
      }
      if(!ok) continue;
      grid[r][c].type='door'; doorPuzzles[`${r},${c}`]=generateDoorPuzzle(`${r},${c}`); doorPlaced++;
    }

    const fakeCount=4;
    for(let i=0;i<fakeCount && idxCand<candidates.length;i++){
      const [r,c]=candidates[idxCand++];
      if(grid[r][c].type==='empty') grid[r][c].type='fakeexit';
    }
  }

  function generateDoorPuzzle(key){
    const types=['symbols','sequence','math'];
    const t=types[Math.floor(Math.random()*types.length)];
    if(t==='symbols'){
      const icons=['ìÇÄ','ìÉ∞','ìÜ£','ìÇì','ìÜ©','ìÑø'];
      shuffleArray(icons);
      const order=icons.slice(0,4), solution=order.slice().reverse();
      return {type:'symbols',icons:order,solution};
    } else if(t==='sequence'){
      const patterns=[['up','up','down','up'],['left','right','left'],['up','left','down','right']];
      const pat=patterns[Math.floor(Math.random()*patterns.length)];
      return {type:'sequence',pattern:pat};
    } else{
      const a=Math.floor(Math.random()*8)+2,b=Math.floor(Math.random()*8)+2,op=Math.random()<0.5?'+':'√ó';
      return {type:'math',prompt:`Quel est ${a} ${op} ${b} ?`,solution:String(op==='+'?a+b:a*b)};
    }
  }

  function renderDisplay(){
    gridEl.innerHTML='';
    const frag=document.createDocumentFragment();
    for(let dr=0;dr<DISPLAY_ROWS;dr++){
      for(let dc=0;dc<DISPLAY_COLS;dc++){
        const r=displayOffsetR+dr,c=displayOffsetC+dc;
        const cell=document.createElement('div');cell.className='cell';
        const g=grid[r][c];if(!g){cell.classList.add('wall');}else{cell.dataset.r=r;cell.dataset.c=c;
        if(g.type==='wall')cell.classList.add('wall');else if(g.type==='empty')cell.classList.add('empty');else if(g.type==='trap'){cell.classList.add('trap');cell.title='Pi√®ge';}
        else if(g.type==='door'){cell.classList.add('door');cell.title='Porte verrouill√©e';}else if(g.type==='fakeexit'){cell.classList.add('fakeexit');cell.title='Fausse sortie';}
        else if(g.type==='exit'){cell.classList.add('exit');cell.title='Sortie';}else cell.classList.add('empty'); g.el=cell;}
        frag.appendChild(cell);
      }
    }
    gridEl.appendChild(frag); placePlayer();
  }

  function placePlayer(){
    document.querySelectorAll('.cell.player').forEach(x=>x.classList.remove('player'));
    adjustCropForPlayer();
    const dr=player.r-displayOffsetR,dc=player.c-displayOffsetC;
    if(dr>=0&&dr<DISPLAY_ROWS&&dc>=0&&dc<DISPLAY_COLS){
      const idx=dr*DISPLAY_COLS+dc,el=gridEl.children[idx];
      if(el) el.classList.add('player');
      try{
        const rect=el.getBoundingClientRect(),wrapRect=boardWrap.getBoundingClientRect();
        if(rect.left<wrapRect.left||rect.right>wrapRect.right||rect.top<wrapRect.top||rect.bottom>wrapRect.bottom){
          boardWrap.scrollTo({left:el.offsetLeft-(boardWrap.clientWidth/2)+(CELL_SIZE/2),top:el.offsetTop-(boardWrap.clientHeight/2)+(CELL_SIZE/2),behavior:'smooth'});
        }
      }catch(e){}
    }
  }

  function adjustCropForPlayer(){
    const margin=6;let changed=false;
    const dr=player.r-displayOffsetR,dc=player.c-displayOffsetC;
    if(dr<margin&&displayOffsetR>1){displayOffsetR=Math.max(1,player.r-margin);changed=true;}
    if(dr>DISPLAY_ROWS-margin-1&&displayOffsetR<ROWS-DISPLAY_ROWS-1){displayOffsetR=Math.min(ROWS-DISPLAY_ROWS-1,player.r-(DISPLAY_ROWS-margin-1));changed=true;}
    if(dc<margin&&displayOffsetC>1){displayOffsetC=Math.max(1,player.c-margin);changed=true;}
    if(dc>DISPLAY_COLS-margin-1&&displayOffsetC<COLS-DISPLAY_COLS-1){displayOffsetC=Math.min(COLS-DISPLAY_COLS-1,player.c-(DISPLAY_COLS-margin-1));changed=true;}
    if(changed) renderDisplay();
  }

  function placeStart(){player.r=1;player.c=1;}

  function placeExit(){for(let r=ROWS-2;r>0;r--)for(let c=COLS-2;c>0;c--)if(grid[r][c].type==='empty'){grid[r][c].type='exit';return;}}

  function saveState(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify({r:player.r,c:player.c,offsetR:displayOffsetR,offsetC:displayOffsetC}));}catch(e){}}
  function loadState(){try{const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');if(s.r!==undefined&&s.c!==undefined){player.r=s.r;player.c=s.c;displayOffsetR=s.offsetR||displayOffsetR;displayOffsetC=s.offsetC||displayOffsetC;}}catch(e){}}

  function bump(r,c){const g=grid[r][c];if(g&&g.el){g.el.classList.add('bump');setTimeout(()=>g.el&&g.el.classList.remove('bump'),120);}}

  function canMoveTo(r,c){if(r<1||c<1||r>=ROWS-1||c>=COLS-1)return false;return grid[r][c].type!=='wall';}
  function moveBy(dr,dc){if(solved)return;const nr=player.r+dr,nc=player.c+dc;if(!canMoveTo(nr,nc)){bump(nr,nc);return;}player.r=nr;player.c=nc;placePlayer();saveState();handleCell(nr,nc);}

  function handleCell(r,c){const t=grid[r][c].type;if(t==='trap'){showModal(`<h2>Pi√®ge !</h2><p>Un m√©canisme ancien te renvoie √† l'entr√©e...</p><div style="display:flex;gap:8px;justify-content:center;margin-top:12px"><button id="okTrap" class="ctl">OK</button></div>`);setTimeout(()=>{document.getElementById('okTrap')?.addEventListener('click',()=>{hideModal();resetToStart();});},50);}
    else if(t==='door'){const key=`${r},${c}`,puzzle=doorPuzzles[key];if(puzzle&&!puzzle.solved) openDoorPuzzle(key,puzzle); else{grid[r][c].type='empty';renderDisplay();placePlayer();}}
    else if(t==='fakeexit'){showModal(`<h2>Fausses glyphes</h2><p>La sortie est une illusion...</p><div style="display:flex;gap:8px;justify-content:center;margin-top:12px"><button id="okFake" class="ctl">OK</button></div>`);setTimeout(()=>{document.getElementById('okFake')?.addEventListener('click',()=>{hideModal();teleportRandom();});},50);}
    else if(t==='exit'){solved=true;showModal(`<h2>Tu as atteint la sortie</h2><p>ecis le mot de passe est :\n\nENVOIE UN MESSAGE PRIVE A HUSER6666666 QUI CERTIFIE SUR L'HONNEUR QUE TU NE DONNERAS CETTE SOLUTION A PERSONNE ET IL TE DONNERA LE MOT DE PASSE</p><div style="display:flex;gap:8px;justify-content:center;margin-top:12px"><a class="ctl" href="index.html">Retour</a> <button id="replay" class="ctl">Recommencer</button></div>`);setTimeout(()=>{document.getElementById('replay')?.addEventListener('click',()=>{hideModal();solved=false;resetToStart();});},50);}}

  function resetToStart(){player.r=1;player.c=1;displayOffsetR=1;displayOffsetC=1;saveState();renderDisplay();}
  function teleportRandom(){const empties=[];for(let r=1;r<ROWS-1;r++)for(let c=1;c<COLS-1;c++)if(grid[r][c].type==='empty')empties.push([r,c]);if(!empties.length)return resetToStart();const [r,c]=empties[Math.floor(Math.random()*empties.length)];player.r=r;player.c=c;saveState();renderDisplay();}

  function openDoorPuzzle(key,puzzle){if(!puzzle)return;
    if(puzzle.type==='symbols'){
      const shuffled=shuffleArray(puzzle.icons.slice());
      showModal(`<h2>Porte scell√©e</h2><p>Clique les symboles dans le bon ordre.</p><div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-top:8px">${shuffled.map(s=>`<button class="ctl symbolBtn">${s}</button>`).join('')}</div>`);
      let seq=[];const buttons=document.querySelectorAll('.symbolBtn');buttons.forEach(b=>b.addEventListener('click',()=>{seq.push(b.textContent);if(seq.length===puzzle.solution.length){if(seq.join('')===puzzle.solution.join('')){puzzle.solved=true;hideModal();grid[player.r][player.c].type='empty';renderDisplay();placePlayer();}else{seq=[];alert('Mauvais ordre !')}};}));
    } else if(puzzle.type==='math'){showModal(`<h2>Porte math√©matique</h2><p>${puzzle.prompt}</p><input id="doorInput" type="text" style="width:60px; margin-top:6px;"><div style="margin-top:8px"><button id="doorOk" class="ctl">Valider</button></div>`);document.getElementById('doorOk')?.addEventListener('click',()=>{const val=document.getElementById('doorInput').value.trim();if(val===puzzle.solution){puzzle.solved=true;hideModal();grid[player.r][player.c].type='empty';renderDisplay();placePlayer();}else alert('Incorrect');});}
    else if(puzzle.type==='sequence'){showModal(`<h2>Porte s√©quence</h2><p>Clique dans cet ordre : ${puzzle.pattern.join(', ')}</p><div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">${puzzle.pattern.map(d=>`<button class="ctl seqBtn">${d}</button>`).join('')}</div>`);let seq=[];document.querySelectorAll('.seqBtn').forEach(b=>b.addEventListener('click',()=>{seq.push(b.textContent);if(seq.length===puzzle.pattern.length){if(seq.join(',')===puzzle.pattern.join(',')){puzzle.solved=true;hideModal();grid[player.r][player.c].type='empty';renderDisplay();placePlayer();}else{seq=[];alert('Mauvaise s√©quence');}}}));}
  }

  function showModal(html){modal.innerHTML=html;modalBackdrop.style.display='flex';modalBackdrop.setAttribute('aria-hidden','false');}
  function hideModal(){modalBackdrop.style.display='none';modalBackdrop.setAttribute('aria-hidden','true');}

  document.addEventListener('keydown',e=>{switch(e.key.toLowerCase()){case 'arrowup':case 'z':moveBy(-1,0);break;case 'arrowdown':case 's':moveBy(1,0);break;case 'arrowleft':case 'q':moveBy(0,-1);break;case 'arrowright':case 'd':moveBy(0,1);break;}});

  upBtn.addEventListener('click',()=>moveBy(-1,0));
  downBtn.addEventListener('click',()=>moveBy(1,0));
  leftBtn.addEventListener('click',()=>moveBy(0,-1));
  rightBtn.addEventListener('click',()=>moveBy(0,1));
  resetBtn.addEventListener('click',()=>{solved=false;generateMaze();scatterHazards();placeStart();placeExit();renderDisplay();});
  homeBtn.addEventListener('click',()=>location.href='index.html');
  modalBackdrop.addEventListener('click',()=>hideModal());

  // initialisation
  generateMaze();scatterHazards();placeStart();placeExit();loadState();renderDisplay();
})();
</script>
</body>
</html>
