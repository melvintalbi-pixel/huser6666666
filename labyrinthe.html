<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Labyrinthe 40×40</title>
<style>
:root{
  --bg:#050304;
  --wall:#0b0705;
  --floor:#2b2218;
  --player:#f6e6b2;
  --door:#4a2f10;
  --exit:#0b6b33;
  --text:#efe6c9;
  --accent:#b98a26;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#020202,var(--bg));font-family:Inter,system-ui,Arial;color:var(--text)}
.wrap{max-width:1000px;margin:18px auto;padding:10px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 12px}
h1{margin:0;font-size:20px;color:var(--accent)}
p.lead{margin:6px 0 0 0;color:#d6c8a3;font-size:13px}

.container { display:flex; gap:14px; padding:10px; align-items:flex-start; }
.board-wrap { overflow:auto; border-radius:10px; background:rgba(0,0,0,0.35); padding:8px; border:1px solid rgba(255,255,255,0.03); max-width:700px; max-height:650px; }
.grid { display:grid; grid-template-columns: repeat(40, 18px); grid-auto-rows: 18px; gap:1px; background:linear-gradient(180deg, rgba(0,0,0,0.03), transparent);}
.cell { width:18px; height:18px; border-radius:2px; box-sizing:border-box; }
.cell.wall { background:var(--wall); }
.cell.empty { background:var(--floor); }
.cell.player { background:linear-gradient(180deg,var(--player), #d4af37); }
.cell.exit { background:linear-gradient(180deg,#0b6b33,#045c2b); border:2px solid rgba(185,138,38,0.12); }

.controls { width:250px; min-width:220px; padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)); border:1px solid rgba(255,255,255,0.03);}
.controls h3{margin:0 0 8px 0;color:var(--accent)}
.stat{margin:8px 0;font-size:13px}
.btns {display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
.ctl { padding:10px;border-radius:8px;background:#241b15;color:var(--text);text-align:center;cursor:pointer;border:1px solid rgba(255,255,255,0.02); user-select:none;}
.small{font-size:12px;color:#cfc1a2;margin-top:10px}

.modal-back { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:200; }
.modal { background:linear-gradient(180deg,#22160f,#0f0b08); padding:18px;border-radius:10px;border:2px solid rgba(185,138,38,0.18); width:360px; color:var(--text); text-align:center; }
.modal h2{margin:6px 0 8px 0;color:var(--accent)}
.modal p{font-size:13px;text-align:left;white-space:pre-wrap;}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div>
    <h1>Labyrinthe 40×40</h1>
    <p class="lead">ZQSD / flèches pour te déplacer. Résous le puzzle pour continuer.</p>
  </div>
</header>

<div class="container">
  <div class="board-wrap" id="boardWrap">
    <div id="grid" class="grid" aria-label="Labyrinthe"></div>
  </div>

  <aside class="controls">
    <h3>Contrôles</h3>
    <div class="stat">Touches: <strong>ZQSD</strong> ou <strong>flèches</strong></div>
    <div class="btns">
      <div></div><div class="ctl" id="upBtn">▲</div><div></div>
      <div class="ctl" id="leftBtn">◀</div><div class="ctl" id="downBtn">▼</div><div class="ctl" id="rightBtn">▶</div>
    </div>
    <div style="margin-top:12px">
      <button class="ctl" id="resetBtn">Réinitialiser</button>
    </div>
  </aside>
</div>
</div>

<div id="modalBackdrop" class="modal-back" aria-hidden="true">
  <div class="modal" id="modal"></div>
</div>

<script>
(function(){
const ROWS = 41; const COLS = 41; // 40x40 + 1 for maze algorithm
const DISPLAY_ROWS = 40; const DISPLAY_COLS = 40;
const CELL_SIZE = 18;
const STORAGE_KEY = "maze40x40";

const gridEl = document.getElementById('grid');
const modalBackdrop = document.getElementById('modalBackdrop');
const modal = document.getElementById('modal');
const upBtn = document.getElementById('upBtn');
const downBtn = document.getElementById('downBtn');
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const resetBtn = document.getElementById('resetBtn');
const boardWrap = document.getElementById('boardWrap');

let grid = [];
let player = {r:1,c:1};
let solved = false;

function initGrid(){
  grid = new Array(ROWS);
  for(let r=0;r<ROWS;r++){
    grid[r]=new Array(COLS);
    for(let c=0;c<COLS;c++) grid[r][c]={type:'wall',el:null};
  }
}

function generateMaze(){
  initGrid();
  const stack=[[1,1]]; grid[1][1].type='empty';
  const dirs=[[0,2],[0,-2],[2,0],[-2,0]];
  while(stack.length){
    const [r,c] = stack[stack.length-1];
    const neighbors=[];
    for(const [dr,dc] of dirs){
      const nr=r+dr,nc=c+dc;
      if(nr>0 && nr<ROWS-1 && nc>0 && nc<COLS-1 && grid[nr][nc].type==='wall') neighbors.push([nr,nc,dr,dc]);
    }
    if(neighbors.length===0) stack.pop();
    else{
      const [nr,nc,dr,dc] = neighbors[Math.floor(Math.random()*neighbors.length)];
      grid[r+dr/2][c+dc/2].type='empty';
      grid[nr][nc].type='empty';
      stack.push([nr,nc]);
    }
  }
}

function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a;}

function scatterMathTrap(){
  const candidates=[];
  for(let r=1;r<ROWS-1;r++) for(let c=1;c<COLS-1;c++)
    if(grid[r][c].type==='empty' && !(r<=2 && c<=2)) candidates.push([r,c]);
  const [r,c] = candidates[Math.floor(Math.random()*candidates.length)];
  grid[r][c].type='mandatoryMath';
}

function placeExit(){
  for(let r=ROWS-2;r>0;r--) for(let c=COLS-2;c>0;c--) if(grid[r][c].type==='empty'){grid[r][c].type='exit'; return;}
}

function renderDisplay(){
  gridEl.innerHTML='';
  const frag=document.createDocumentFragment();
  for(let r=1;r<=DISPLAY_ROWS;r++){
    for(let c=1;c<=DISPLAY_COLS;c++){
      const cell=document.createElement('div'); cell.className='cell';
      const g=grid[r][c];
      if(!g) cell.classList.add('wall');
      else { g.el=cell; if(g.type==='wall') cell.classList.add('wall'); else if(g.type==='empty') cell.classList.add('empty');
             else if(g.type==='mandatoryMath'){cell.classList.add('door'); cell.title='Puzzle obligatoire';}
             else if(g.type==='exit'){cell.classList.add('exit'); cell.title='Sortie';}}
      frag.appendChild(cell);
    }
  }
  gridEl.appendChild(frag);
  placePlayer();
}

function placePlayer(){
  document.querySelectorAll('.cell.player').forEach(x=>x.classList.remove('player'));
  const idx=(player.r-1)*DISPLAY_COLS+(player.c-1);
  const el=gridEl.children[idx];
  if(el) el.classList.add('player');
  boardWrap.scrollTo({left:el.offsetLeft-350, top:el.offsetTop-300});
}

function canMoveTo(r,c){return r>0 && r<ROWS && c>0 && c<COLS && grid[r][c].type!=='wall';}
function moveBy(dr,dc){if(solved) return; const nr=player.r+dr,nc=player.c+dc;if(!canMoveTo(nr,nc)) return; player.r=nr; player.c=nc; placePlayer(); handleCell(nr,nc);}
function handleCell(r,c){
  const t=grid[r][c].type;
  if(t==='mandatoryMath') openMandatoryMathPuzzle(r,c);
  else if(t==='exit'){solved=true; showModal(`<h2>Sortie atteinte !</h2><p>Mot de passe : ENVOIE UN MESSAGE PRIVÉ A HUSER6666666 QUI CERTIFIE SUR L'HONNEUR QUE TU NE DONNERAS CETTE SOLUTION A PERSONNE.</p><div style="margin-top:10px"><button onclick="window.location.reload()" class="ctl">Rejouer</button></div>`);}
}

function openMandatoryMathPuzzle(r,c){
  showModal(`<h2>Puzzle obligatoire</h2><p>Résous le calcul pour continuer :</p><p style="font-weight:bold;">Quel est le nombre magique ?</p><input id="mathInput" style="width:80px;margin-top:6px"><div style="margin-top:8px"><button id="mathOk" class="ctl">Valider</button></div>`);
  document.getElementById('mathOk').onclick=function(){
    const val=document.getElementById('mathInput').value.trim();
    if(val==='6666666'){ hideModal(); grid[r][c].type='empty'; renderDisplay(); placePlayer(); }
    else alert('Mauvaise réponse !');
  }
}

function showModal(html){modal.innerHTML=html; modalBackdrop.style.display='flex';}
function hideModal(){modalBackdrop.style.display='none';}

function setup(){
  generateMaze();
  scatterMathTrap();
  placeExit();
  renderDisplay();
}

upBtn.onclick=()=>moveBy(-1,0);
downBtn.onclick=()=>moveBy(1,0);
leftBtn.onclick=()=>moveBy(0,-1);
rightBtn.onclick=()=>moveBy(0,1);
resetBtn.onclick=()=>setup();
window.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(k==='z'||k==='arrowup') moveBy(-1,0);
  if(k==='s'||k==='arrowdown') moveBy(1,0);
  if(k==='q'||k==='arrowleft') moveBy(0,-1);
  if(k==='d'||k==='arrowright') moveBy(0,1);
});
modalBackdrop.onclick=(e)=>{if(e.target===modalBackdrop) hideModal();}

setup();
})();
</script>
</body>
</html>
