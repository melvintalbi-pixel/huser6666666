<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Labyrinthe — Hardcore 40×40</title>
<style>
  :root{
    --bg:#050304;
    --wall:#0b0705;
    --floor:#2b2218;
    --player:#f6e6b2;
    --trap:#7b1420;
    --door:#4a2f10;
    --exit:#0b6b33;
    --text:#efe6c9;
    --accent:#b98a26;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#020202,var(--bg));font-family:Inter,system-ui,Arial;color:var(--text)}
  .wrap{max-width:1200px;margin:18px auto;padding:10px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 12px}
  h1{margin:0;font-size:20px;color:var(--accent)}
  p.lead{margin:6px 0 0 0;color:#d6c8a3;font-size:13px}

  .container { display:flex; gap:14px; padding:10px; align-items:flex-start; }
  .board-wrap { overflow:auto; border-radius:10px; background:rgba(0,0,0,0.35); padding:8px; border:1px solid rgba(255,255,255,0.03); }
  .grid {
    display:grid;
    grid-template-columns: repeat(40, 16px);
    grid-auto-rows: 16px;
    gap:1px;
    background:linear-gradient(180deg, rgba(0,0,0,0.03), transparent);
  }
  .cell { width:16px; height:16px; border-radius:2px; box-sizing:border-box; }
  .cell.wall { background:var(--wall); box-shadow: inset 0 0 4px rgba(0,0,0,0.7); }
  .cell.empty { background:var(--floor); }
  .cell.player { background:linear-gradient(180deg,var(--player), #d4af37); box-shadow:0 1px 3px rgba(0,0,0,0.6); }
  .cell.trap { background:var(--trap); }
  .cell.door { background:var(--door); }
  .cell.fakeexit { background:#08303a; opacity:0.9; }
  .cell.exit { background:linear-gradient(180deg,#0b6b33,#045c2b); border:2px solid rgba(185,138,38,0.12); }

  .controls {
    width:300px;
    min-width:260px;
    padding:12px;
    border-radius:10px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));
    border:1px solid rgba(255,255,255,0.03);
  }
  .controls h3{margin:0 0 8px 0;color:var(--accent)}
  .stat{margin:8px 0;font-size:13px}
  .btns {display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
  .ctl { padding:10px;border-radius:8px;background:#241b15;color:var(--text);text-align:center;cursor:pointer;border:1px solid rgba(255,255,255,0.02); user-select:none;}
  .small{font-size:12px;color:#cfc1a2;margin-top:10px}

  .legend { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .legend .item { font-size:12px; display:flex; gap:6px; align-items:center; }
  .swatch { width:14px;height:14px;border-radius:3px; display:inline-block; }

  .modal-back { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:200; }
  .modal { background:linear-gradient(180deg,#22160f,#0f0b08); padding:18px;border-radius:10px;border:2px solid rgba(185,138,38,0.18); width:360px; color:var(--text); text-align:center; }
  .modal h2{margin:6px 0 8px 0;color:var(--accent)}
  .modal p{font-size:13px;text-align:left;white-space:pre-wrap;}

  @media (max-width:980px){
    .container { flex-direction:column; align-items:center; }
    .controls { width:100%; max-width:560px; }
    .board-wrap{ max-width:100%; overflow:auto; }
  }

  .bump { animation: bumpAnim 120ms linear; }
  @keyframes bumpAnim {
    0%{ transform:translateX(0); } 25%{ transform:translateX(-6px);} 50%{ transform:translateX(6px);} 100%{ transform:translateX(0); }
  }

  .mobile-tip { display:none; margin-top:8px; font-size:12px; color:#d9cfa2; }
  @media (max-width:640px){ .mobile-tip{display:block} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Labyrinthe — Niveau : Hardcore Ultime (40×40)</h1>
        <p class="lead">ZQSD / flèches pour te déplacer. Beaucoup de pièges & portes. Bonne chance.</p>
      </div>
      <div class="small">Taille : 40×40 — sauvegarde locale</div>
    </header>

    <div class="container">
      <div class="board-wrap" id="boardWrap" style="max-width:700px; max-height:560px;">
        <div id="grid" class="grid" aria-label="Labyrinthe"></div>
      </div>

      <aside class="controls">
        <h3>Contrôles</h3>
        <div class="stat">Touches: <strong>ZQSD</strong> ou <strong>flèches</strong></div>
        <div class="btns">
          <div></div>
          <div class="ctl" id="upBtn">▲</div>
          <div></div>
          <div class="ctl" id="leftBtn">◀</div>
          <div class="ctl" id="downBtn">▼</div>
          <div class="ctl" id="rightBtn">▶</div>
        </div>
        <div class="mobile-tip">Sur mobile, utilise les boutons. Tapote plusieurs fois pour avancer rapidement.</div>

        <div class="legend">
          <div class="item"><span class="swatch" style="background:var(--floor)"></span> Couloir</div>
          <div class="item"><span class="swatch" style="background:var(--wall)"></span> Mur</div>
          <div class="item"><span class="swatch" style="background:var(--trap)"></span> Piège (téléporte)</div>
          <div class="item"><span class="swatch" style="background:var(--door)"></span> Porte (mini-énigme)</div>
          <div class="item"><span class="swatch" style="background:var(--exit)"></span> Sortie</div>
        </div>

        <div style="margin-top:12px">
          <button class="ctl" id="resetBtn">Réinitialiser</button>
          <button class="ctl" id="homeBtn" style="margin-left:8px">Retour</button>
        </div>
      </aside>
    </div>
  </div>

  <div id="modalBackdrop" class="modal-back" aria-hidden="true">
    <div class="modal" id="modal"></div>
  </div>

<script>
(function(){
  const ROWS = 41; // internal odd-based grid for maze
  const COLS = 41;
  const DISPLAY_ROWS = 40;
  const DISPLAY_COLS = 40;
  const CELL_SIZE = 16;
  const STORAGE_KEY = "hardcore_maze_40_state";

  const gridEl = document.getElementById('grid');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modal = document.getElementById('modal');
  const upBtn = document.getElementById('upBtn');
  const downBtn = document.getElementById('downBtn');
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const resetBtn = document.getElementById('resetBtn');
  const homeBtn = document.getElementById('homeBtn');
  const boardWrap = document.getElementById('boardWrap');

  let grid=[], player={r:1,c:1}, displayOffsetR=1, displayOffsetC=1,
