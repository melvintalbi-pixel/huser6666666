<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Labyrinthe Fullscreen</title>
<style>
:root{
  --bg:#050304;
  --wall:#0b0705;
  --floor:#2b2218;
  --player:#f6e6b2;
  --door:#4a2f10;
  --exit:#0b6b33;
  --text:#efe6c9;
  --accent:#b98a26;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial;color:var(--text);display:flex;justify-content:center;align-items:center;}
#boardWrap{flex:none; display:flex; justify-content:center; align-items:center; border-radius:10px; background:rgba(0,0,0,0.35); padding:8px; border:1px solid rgba(255,255,255,0.03);}
.grid{display:grid; grid-template-columns:repeat(20,25px); grid-auto-rows:25px; gap:1px;}
.cell{width:25px; height:25px; border-radius:2px; box-sizing:border-box;}
.cell.wall{background:var(--wall);}
.cell.empty{background:var(--floor);}
.cell.player{background:linear-gradient(180deg,var(--player),#d4af37);}
.cell.door{background:var(--door);}
.cell.exit{background:linear-gradient(180deg,#0b6b33,#045c2b); border:2px solid rgba(185,138,38,0.12);}

#controls{position:fixed; top:10px; right:10px; background:rgba(0,0,0,0.25); padding:10px; border-radius:8px; display:flex; flex-direction:column; gap:6px;}
.ctl{padding:6px 10px; border-radius:6px; background:#241b15; color:var(--text); text-align:center; cursor:pointer; user-select:none;}

.modal-back{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); align-items:center; justify-content:center; z-index:200;}
.modal{background:linear-gradient(180deg,#22160f,#0f0b08); padding:18px; border-radius:10px; border:2px solid rgba(185,138,38,0.18); width:300px; color:var(--text); text-align:center;}
.modal h2{margin:6px 0 8px 0;color:var(--accent);}
.modal p{font-size:13px; white-space:pre-wrap;}
input[type=text]{width:80px; padding:5px; margin-top:6px;}
</style>
</head>
<body>
<div id="boardWrap">
  <div id="grid" class="grid"></div>
</div>

<div id="controls">
  <div class="ctl" id="upBtn">▲</div>
  <div style="display:flex; gap:6px;">
    <div class="ctl" id="leftBtn">◀</div>
    <div class="ctl" id="downBtn">▼</div>
    <div class="ctl" id="rightBtn">▶</div>
  </div>
  <div class="ctl" id="resetBtn">Réinitialiser</div>
</div>

<div id="modalBackdrop" class="modal-back">
  <div class="modal" id="modal"></div>
</div>

<script>
(function(){
const ROWS=21, COLS=21; // 20x20 maze
const gridEl=document.getElementById('grid');
const modalBackdrop=document.getElementById('modalBackdrop');
const modal=document.getElementById('modal');
const upBtn=document.getElementById('upBtn');
const downBtn=document.getElementById('downBtn');
const leftBtn=document.getElementById('leftBtn');
const rightBtn=document.getElementById('rightBtn');
const resetBtn=document.getElementById('resetBtn');

let grid=[], player={r:1,c:1}, solved=false;

function initGrid(){
  grid=new Array(ROWS).fill(0).map(()=>new Array(COLS).fill(0).map(()=>({type:'wall',el:null})));
}

function generateMaze(){
  initGrid();
  const stack=[[1,1]]; grid[1][1].type='empty';
  const dirs=[[0,2],[0,-2],[2,0],[-2,0]];
  while(stack.length){
    const [r,c]=stack[stack.length-1];
    const neighbors=[];
    for(const [dr,dc] of dirs){
      const nr=r+dr,nc=c+dc;
      if(nr>0&&nr<ROWS-1&&nc>0&&nc<COLS-1&&grid[nr][nc].type==='wall') neighbors.push([nr,nc,dr,dc]);
    }
    if(neighbors.length===0) stack.pop();
    else{
      const [nr,nc,dr,dc]=neighbors[Math.floor(Math.random()*neighbors.length)];
      grid[r+dr/2][c+dc/2].type='empty';
      grid[nr][nc].type='empty';
      stack.push([nr,nc]);
    }
  }
}

function placeMandatoryTrap(){
  const empties=[];
  for(let r=1;r<ROWS-1;r++) for(let c=1;c<COLS-1;c++)
    if(grid[r][c].type==='empty' && !(r<=2 && c<=2)) empties.push([r,c]);
  const [r,c]=empties[Math.floor(Math.random()*empties.length)];
  grid[r][c].type='door'; // use door style for trap
  grid[r][c].trap=true;
}

function placeExit(){
  for(let r=ROWS-2;r>0;r--) for(let c=COLS-2;c>0;c--)
    if(grid[r][c].type==='empty'){grid[r][c].type='exit'; return;}
}

function renderDisplay(){
  gridEl.innerHTML='';
  const frag=document.createDocumentFragment();
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const cell=document.createElement('div'); cell.className='cell';
      const g=grid[r][c]; g.el=cell;
      if(g.type==='wall') cell.classList.add('wall');
      else if(g.type==='empty') cell.classList.add('empty');
      else if(g.type==='door') cell.classList.add('door');
      else if(g.type==='exit') cell.classList.add('exit');
      frag.appendChild(cell);
    }
  }
  gridEl.appendChild(frag);
  placePlayer();
}

function placePlayer(){
  document.querySelectorAll('.cell.player').forEach(x=>x.classList.remove('player'));
  const idx=player.r*COLS+player.c;
  const el=gridEl.children[idx];
  if(el) el.classList.add('player');
}

function canMoveTo(r,c){return r>=0&&r<ROWS&&c>=0&&c<COLS&&grid[r][c].type!=='wall';}
function moveBy(dr,dc){
  if(solved) return;
  const nr=player.r+dr,nc=player.c+dc;
  if(!canMoveTo(nr,nc)) return;
  player.r=nr; player.c=nc;
  placePlayer();
  handleCell(nr,nc);
}

function handleCell(r,c){
  const g=grid[r][c];
  if(g.trap) openTrapPuzzle(g);
  else if(g.type==='exit'){solved=true; showModal(`<h2>Sortie atteinte !</h2><p>Mot de passe : ENVOIE UN MESSAGE PRIVÉ A HUSER6666666 QUI CERTIFIE SUR L'HONNEUR QUE TU NE DONNERAS CETTE SOLUTION A PERSONNE.</p><div style="margin-top:10px"><button onclick="window.location.reload()" class="ctl">Rejouer</button></div>`);}
}

function openTrapPuzzle(cell){
  showModal(`<h2>Puzzle obligatoire</h2><p>Résous le calcul pour continuer :</p><p style="font-weight:bold;">Quel est le nombre magique ?</p><input id="mathInput"><div style="margin-top:8px"><button id="mathOk" class="ctl">Valider</button></div>`);
  document.getElementById('mathOk').onclick=function(){
    const val=document.getElementById('mathInput').value.trim();
    if(val==='6666666'){ hideModal(); cell.type='empty'; cell.trap=false; renderDisplay(); placePlayer();}
    else alert('Mauvaise réponse !');
  }
}

function showModal(html){modal.innerHTML=html; modalBackdrop.style.display='flex';}
function hideModal(){modalBackdrop.style.display='none';}

function setup(){
  solved=false; player={r:1,c:1};
  generateMaze(); placeMandatoryTrap(); placeExit(); renderDisplay();
}

upBtn.onclick=()=>moveBy(-1,0);
downBtn.onclick=()=>moveBy(1,0);
leftBtn.onclick=()=>moveBy(0,-1);
rightBtn.onclick=()=>moveBy(0,1);
resetBtn.onclick=()=>setup();

window.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if(k==='z'||k==='arrowup') moveBy(-1,0);
  if(k==='s'||k==='arrowdown') moveBy(1,0);
  if(k==='q'||k==='arrowleft') moveBy(0,-1);
  if(k==='d'||k==='arrowright') moveBy(0,1);
});

modalBackdrop.onclick=(e)=>{if(e.target===modalBackdrop) hideModal();}
setup();
})();
</script>
</body>
</html>
