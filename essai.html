<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>.huser6666666. Bonjour Christilla. .allons-y.</title>
<style>
body {
  background: #000;
  color: #eee;
  font-family: 'Courier New', monospace;
  text-align: center;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}
h1 {
  color: #941F06;
  letter-spacing: 2px;
  font-size: 1.5em;
  margin-bottom: 20px;
}
#arrow {
  width: 120px;
  height: 120px;
  transition: transform 0.1s linear;
  filter: drop-shadow(0 0 10px #941F06);
}
#status {
  margin-top: 20px;
  font-size: 1.1em;
  color: #fff;
}
svg {
  width: 100%;
  height: 100%;
  fill: #941F06;
}
.tap {
  position: fixed;
  bottom: 15px;
  font-size: 0.9em;
  color: #fff;
  opacity: 0.8;
}
</style>
</head>
<body>
  <h1>.huser6666666. Bonjour Christilla. .allons-y.</h1>
  <div id="arrow">
    <svg viewBox="0 0 24 24">
      <path d="M12 2L4 10h5v10h6V10h5L12 2z"/>
    </svg>
  </div>
  <div id="status">activation du GPS...</div>
  <div class="tap">(tape l’écran pour activer le GPS et la boussole)</div>

<script>
// === CONFIG ===
const target = { lat: 49.033094, lon: 2.077448 }; // 🧭 change ici
const sound100 = "https://www.chosic.com/wp-content/uploads/2023/06/heartbeat-soundsmith-1(chosic.com).mp3"; // battement lent
const sound50  = "https://www.chosic.com/wp-content/uploads/2023/06/heartbeat-soundsmith(chosic.com).mp3"; // battement rapide
const horror20 = "https://www.chosic.com/wp-content/uploads/2022/10/its-in-the-fog(chosic.com).mp3";    // musique horreur
// ==============

let currentPos = null;
let currentHeading = 0;
let currentZone = null; // "none" | "100" | "50" | "20"
let playersAudio = {};

function toRad(deg){ return deg * Math.PI/180; }
function toDeg(rad){ return rad * 180/Math.PI; }

function distance(lat1, lon1, lat2, lon2){
  const R=6371e3;
  const φ1=toRad(lat1), φ2=toRad(lat2);
  const Δφ=toRad(lat2-lat1), Δλ=toRad(lon2-lon1);
  const a=Math.sin(Δφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function bearing(lat1,lon1,lat2,lon2){
  const φ1=toRad(lat1), φ2=toRad(lat2);
  const Δλ=toRad(lon2-lon1);
  const y=Math.sin(Δλ)*Math.cos(φ2);
  const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (toDeg(Math.atan2(y,x))+360)%360;
}

function handleOrientation(event){
  if(event.absolute || event.webkitCompassHeading){
    currentHeading = event.webkitCompassHeading || 360 - event.alpha;
  }
  updateArrow();
}

function handlePosition(pos){
  currentPos = pos.coords;
  updateArrow();
}

function updateArrow(){
  if(!currentPos) return;
  const dist = distance(currentPos.latitude, currentPos.longitude, target.lat, target.lon);
  const bear = bearing(currentPos.latitude, currentPos.longitude, target.lat, target.lon);
  const angle = (bear - currentHeading + 360) % 360;
  document.getElementById('arrow').style.transform = `rotate(${angle}deg)`;

  const status = document.getElementById('status');

  if(dist > 100){
    status.textContent = `.encore ${Math.round(dist)} mètres...`;
    switchZone("none");
  } else if(dist > 50){
    status.textContent = ".tu t'approches...";
    switchZone("100");
  } else if(dist > 20){
    status.textContent = ".je sens ton souffle...";
    switchZone("50");
  } else {
    status.textContent = ".regarde autour de toi... la croix t'attend.";
    switchZone("20");
  }
}

// === Gestion audio par zone ===
function playLoop(id, url, volume=0.7){
  if(playersAudio[id]) return;
  const a = new Audio(url);
  a.loop = true;
  a.volume = volume;
  a.play().catch(()=>{});
  playersAudio[id] = a;
}

function stopAll(except){
  for(const [k,a] of Object.entries(playersAudio)){
    if(k !== except){
      a.pause();
      delete playersAudio[k];
    }
  }
}

function switchZone(zone){
  if(zone === currentZone) return;
  currentZone = zone;
  stopAll();
  if(zone === "100"){
    playLoop("beat100", sound100, 0.6);
  } else if(zone === "50"){
    playLoop("beat50", sound50, 0.8);
  } else if(zone === "20"){
    const a = new Audio(horror20);
    a.loop = false;
    a.volume = 1.0;
    a.play().catch(()=>{});
    playersAudio["horror20"] = a;
  }
}

// === Init & permissions ===
function init(){
  document.querySelector('.tap').style.display='none';

  if(window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission==='function'){
    DeviceOrientationEvent.requestPermission().then(state=>{
      if(state==='granted'){
        window.addEventListener('deviceorientation', handleOrientation, true);
      } else alert("Autorise la boussole pour jouer !");
    });
  } else {
    window.addEventListener('deviceorientation', handleOrientation, true);
  }

  navigator.geolocation.watchPosition(handlePosition, e=>{
    document.getElementById('status').textContent="GPS indisponible...";
  }, {enableHighAccuracy:true});

  // léger fondu de démarrage
  const start = new Audio(sound100);
  start.volume=0.2;
  start.play().catch(()=>{});
}

document.body.addEventListener('click', init, {once:true});
</script>
</body>
</html>
