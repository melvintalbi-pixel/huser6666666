<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NOX // Hardcore Escape</title>
  <meta name="description" content="Escape game web hardcore, 4 salles + mÃ©tapuzzle, vÃ©rification par hash, timer, terminal, VigenÃ¨re, UV, boussole. 100% client-side." />
  <style>
    :root{
      --bg:#070911; --panel:#0e1422; --ink:#e7eef8; --muted:#98a7bd; --accent:#7cc0ff; --accent2:#aaf683; --accent3:#ffbe0b; --danger:#ff5c8a; --ok:#8cffc1; --radius:18px; --shadow:0 12px 40px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.03);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans;letter-spacing:.2px;background:radial-gradient(1200px 600px at 70% -120px, rgba(124,192,255,.15), transparent 60%), var(--bg);color:var(--ink)}
    .container{max-width:1100px;margin:0 auto;padding:28px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:0 0 16px}
    h1{font-size:clamp(1.2rem,2.8vw,2rem);margin:0}
    .badge{padding:6px 10px;border-radius:999px;background:linear-gradient(135deg,rgba(124,192,255,.15),rgba(170,246,131,.12));border:1px solid rgba(255,255,255,.08);font-size:.85rem;color:var(--muted)}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.00));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin:14px 0}
    .row{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}

    .controls{display:flex;flex-wrap:wrap;gap:10px}
    .btn{appearance:none;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.02);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .05s ease, background .2s ease, border-color .2s ease;box-shadow:var(--shadow);font-weight:700}
    .btn:hover{background:rgba(124,192,255,.08)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(135deg,rgba(124,192,255,.18),rgba(170,246,131,.14));border-color:rgba(124,192,255,.35)}
    .btn.warn{background:linear-gradient(135deg,rgba(255,92,138,.18),rgba(255,190,11,.12));border-color:rgba(255,92,138,.35)}

    .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);color:var(--muted)}
    .topbar{display:flex;align-items:center;justify-content:space-between}
    .stats{display:flex;gap:10px;flex-wrap:wrap}

    .room-title{font-weight:800;letter-spacing:.3px;margin:0 0 6px;font-size:1.05rem;color:var(--accent)}
    .story{color:var(--muted);line-height:1.6}
    .lock{display:grid;gap:8px}
    input[type="text"], input[type="number"], textarea{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.02);color:var(--ink);font-weight:700;letter-spacing:.6px}
    .input{display:flex;gap:10px;align-items:center}
    .status{font-size:.9rem}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--danger)}
    .hint{font-size:.92rem;color:var(--muted);background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.15);padding:10px 12px;border-radius:12px;margin-top:10px}
    .hidden{display:none}

    /* UV note */
    .uv-note{position:relative;border-radius:16px;border:1px solid rgba(124,192,255,.25);background:repeating-linear-gradient(-8deg, rgba(124,192,255,.05), rgba(124,192,255,.05) 14px, rgba(255,255,255,0) 14px, rgba(255,255,255,0) 28px), rgba(255,255,255,.02);padding:14px 16px;line-height:1.6;min-height:120px}
    .uv{color:#0e1422;transition:color .2s ease}
    body.uv-on .uv{color:var(--accent);text-shadow:0 0 12px rgba(124,192,255,.8)}
    .rot{display:flex;align-items:center;gap:8px}

    /* Compass */
    .compass{position:relative;aspect-ratio:1/1;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:radial-gradient(circle at 50% 55%, rgba(255,255,255,.06), rgba(255,255,255,0) 48%), rgba(255,255,255,.02);display:grid;place-items:center;box-shadow:var(--shadow)}
    .needle{position:absolute;width:2px;height:46%;background:linear-gradient(var(--accent), transparent);transform-origin:50% 90%;transform:rotate(0deg);transition:transform .5s ease}
    .marks{position:absolute;inset:8px;display:grid;place-items:center;font-weight:700;color:var(--muted)}
    .marks span{position:absolute}
    .marks .n{top:4px}
    .marks .e{right:6px}
    .marks .s{bottom:4px}
    .marks .o{left:6px}

    /* Terminal */
    .term{background:#06070d;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;color:#cce3ff;line-height:1.5;height:240px;overflow:auto}
    .prompt{display:flex;gap:8px;align-items:center;margin-top:8px}
    .prompt input{flex:1;font-family:inherit}

    /* Final */
    .final{display:none;position:fixed;inset:0;background:rgba(7,9,17,.9);backdrop-filter: blur(6px);z-index:60;align-items:center;justify-content:center}
    .final-card{max-width:760px;margin:20px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.12);border-radius:24px;box-shadow:var(--shadow);padding:24px;text-align:center}

    .token{display:inline-block;padding:3px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:rgba(170,246,131,.08);color:var(--accent2);font-weight:800;margin-left:6px}

    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width:700px){.grid4{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="left">
        <div class="badge">Hardcore Â· 4 salles + MÃ©tapuzzle</div>
        <h1>NOX â€” L'Atelier Interdit</h1>
      </div>
      <div class="controls">
        <button class="btn" id="btnUV" title="Lampe UV">ğŸ”¦ UV</button>
        <button class="btn warn" id="btnHard" title="Mode Hardcore">ğŸ”¥ Hardcore</button>
        <button class="btn" id="btnReset" title="RÃ©initialiser">â†º RESET</button>
      </div>
    </header>

    <div class="panel topbar">
      <div class="stats">
        <div class="chip" id="timer">â±ï¸ 00:00</div>
        <div class="chip" id="lives">â¤ï¸ ViesÂ : âˆ</div>
        <div class="chip" id="progress">ğŸ”’ ProgressionÂ : 0/4</div>
      </div>
      <div class="stats">
        <div class="chip">InventaireÂ : <span id="tokens"></span></div>
      </div>
    </div>

    <!-- ROOM 1 -->
    <section class="panel" id="r1">
      <div class="row">
        <div>
          <h2 class="room-title">Salle 1 â€” Palimpseste UV + CÃ©sar</h2>
          <p class="story">Un billet griffonnÃ©. Une molette indique Â«Â ROT <span id="rotVal">13</span>Â Â». Le texte semble chiffrÃ©. Les lettres rÃ©actives Ã  l'UV paraissent former un nomâ€¦</p>
          <div class="uv-note" id="note1">
            V'z n yrnir <span class="uv">W</span> va ivpyr: Â«Â Gb yrg gur <span class="uv">N</span>rqynaq sbphf, 
            arkg gb gur <span class="uv">H</span>rqtr, naq <span class="uv">H</span>agvy gur <span class="uv">A</span>cvrg unccraf.Â Â»
          </div>
          <div class="rot"><label for="rot">ROTÂ </label><input id="rot" type="range" min="1" max="25" value="13" /><span class="chip" id="rotOut">13</span></div>
          <div class="hint" id="h1" hidden>ğŸ’¡ AstuceÂ : Mets ROT sur 13 (classique Â«Â ROT13Â Â»), lis le billet, puis garde les lettres qui brillent sous UV pour former le mot.</div>
        </div>
        <div>
          <div class="lock">
            <label for="a1">Mot (5 lettres)</label>
            <div class="input">
              <input id="a1" type="text" placeholder="â€” â€” â€” â€” â€”" aria-describedby="s1" />
              <button class="btn primary" id="b1">DÃ©verrouiller</button>
            </div>
            <div class="status" id="s1"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ROOM 2 -->
    <section class="panel hidden" id="r2">
      <div class="row">
        <div>
          <h2 class="room-title">Salle 2 â€” Rose des vents & Ï€</h2>
          <p class="story">Une boussole et un haÃ¯ku :
          <br>Â«Â Quatre vents dictent / Compte leurs lettres, puis cherche / Le cercle des dieux.Â Â»</p>
          <div class="grid4">
            <div class="compass" aria-hidden="true">
              <div class="needle" id="needle"></div>
              <div class="marks"><span class="n">N</span><span class="e">E</span><span class="s">S</span><span class="o">O</span></div>
            </div>
            <div class="panel" style="min-height:120px">
              <strong>ConsigneÂ :</strong>
              <ul class="story">
                <li>Nombre de lettresÂ : Nord, Est, Sud, Ouest â†’ concatÃ¨ne.</li>
                <li>Puis Ã©lÃ¨ve ce nombre au cercle sacrÃ© (Ï€)Â : conserve seulement les 5 premiÃ¨res dÃ©cimales.</li>
              </ul>
            </div>
            <div class="panel" style="grid-column: span 2">
              <em>ExempleÂ :</em> si tu obtenais 1234, cherche Ï€ â‰ˆ 3.14159â€¦ â†’ garde 31415.
            </div>
          </div>
          <div class="hint" id="h2" hidden>ğŸ’¡ AstuceÂ : Lettres â†’ N(4) E(3) S(3) O(5) â†’ 4335 â†’ garde 3.1415 â†’ code = 31415.</div>
        </div>
        <div>
          <div class="lock">
            <label for="a2">Code (5 chiffres)</label>
            <div class="input">
              <input id="a2" type="number" inputmode="numeric" placeholder="â€” â€” â€” â€” â€”" aria-describedby="s2" />
              <button class="btn primary" id="b2">DÃ©verrouiller</button>
            </div>
            <div class="status" id="s2"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ROOM 3 -->
    <section class="panel hidden" id="r3">
      <div class="row">
        <div>
          <h2 class="room-title">Salle 3 â€” VigenÃ¨re (clÃ© = rÃ©ponse salleÂ 1)</h2>
          <p class="story">Une plaque : Â«Â ClÃ© de CÃ©sar devenue dieu biface â†’ rÃ©utilise-laÂ Â». Entre la <strong>clÃ©</strong>, puis dÃ©chiffre le message pour trouver un <strong>mot</strong>.</p>
          <div class="panel">
            <label for="key3">ClÃ© VigenÃ¨re</label>
            <div class="input"><input id="key3" type="text" placeholder="(rÃ©ponse salle 1)" /><button class="btn" id="genCT">GÃ©nÃ©rer le cryptogramme</button></div>
            <label for="ct3">Cryptogramme</label>
            <textarea id="ct3" rows="3" readonly></textarea>
          </div>
          <div class="hint" id="h3" hidden>ğŸ’¡ AstuceÂ : Rentre comme clÃ© le dieu gardien des portes dÃ©couvert en salleÂ 1. Le texte dÃ©chiffrÃ© contient Â«Â TROUVE LE MOTÂ : MINOTAUREÂ Â».</div>
        </div>
        <div>
          <div class="lock">
            <label for="a3">Mot (8â€“10 lettres)</label>
            <div class="input">
              <input id="a3" type="text" placeholder="â€” â€” â€” â€” â€” â€” â€” â€”" aria-describedby="s3" />
              <button class="btn primary" id="b3">DÃ©verrouiller</button>
            </div>
            <div class="status" id="s3"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ROOM 4 -->
    <section class="panel hidden" id="r4">
      <div class="row">
        <div>
          <h2 class="room-title">Salle 4 â€” Terminal fantÃ´me</h2>
          <p class="story">Un vieux terminal bourdonne. On dirait un mini-systÃ¨me. Tape <code>help</code>, <code>ls</code>, puis fouille. Un mot-clÃ© s'y cache.</p>
          <div class="term" id="term" aria-live="polite"></div>
          <div class="prompt"><span class="chip">guest@nox:~$</span><input id="cmd" type="text" placeholder="help" /><button class="btn" id="run">â†µ</button></div>
          <div class="hint" id="h4" hidden>ğŸ’¡ AstuceÂ : <code>ls</code> â†’ <code>cat journal.log</code> â†’ repÃ¨re les lignes marquÃ©es [EYES] et assemble les initiales â†’ AR G O S.</div>
        </div>
        <div>
          <div class="lock">
            <label for="a4">Mot (5 lettres)</label>
            <div class="input">
              <input id="a4" type="text" placeholder="â€” â€” â€” â€” â€”" aria-describedby="s4" />
              <button class="btn primary" id="b4">DÃ©verrouiller</button>
            </div>
            <div class="status" id="s4"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- META -->
    <section class="panel hidden" id="meta">
      <h2 class="room-title">Porte finale â€” La Forge</h2>
      <p class="story">Assemble les quatre rÃ©ponses dans l'ordre et laisse la Forge calculer la <em>signature</em>. Tu devras entrer le <strong>mot de passe final</strong> que la Forge rÃ©vÃ¨leâ€¦ si tu as tout bon.</p>
      <div class="grid4">
        <div class="panel"><label>R1</label><input id="m1" type="text" readonly></div>
        <div class="panel"><label>R2</label><input id="m2" type="text" readonly></div>
        <div class="panel"><label>R3</label><input id="m3" type="text" readonly></div>
        <div class="panel"><label>R4</label><input id="m4" type="text" readonly></div>
      </div>
      <div class="controls" style="margin-top:10px"><button class="btn primary" id="forge">Forger la signature</button><span id="sig" class="chip">â€”</span></div>
      <div class="lock" style="margin-top:12px">
        <label for="af">Mot de passe final</label>
        <div class="input"><input id="af" type="text" placeholder="â€” â€” â€” â€” â€”" aria-describedby="sf" /><button class="btn primary" id="bf">Ouvrir</button></div>
        <div class="status" id="sf"></div>
      </div>
    </section>
  </div>

  <!-- FINAL OVERLAY -->
  <div class="final" id="final">
    <div class="final-card">
      <h2>ğŸšª Ouverture rÃ©ussie</h2>
      <p>TempsÂ : <strong id="tFinal">â€”</strong> Â· Vies restantesÂ : <strong id="lifeFinal">â€”</strong></p>
      <p>FragmentsÂ : <span id="tokFinal"></span></p>
      <div class="controls" style="justify-content:center"><button class="btn primary" id="again">Rejouer</button></div>
    </div>
  </div>

<script>
(()=>{
  const $= (s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9]/g,'');

  const state={
    hard:false, lives:Infinity, strikes:0, started:Date.now(), tries:{r1:0,r2:0,r3:0,r4:0}, solved:{r1:false,r2:false,r3:false,r4:false}, answers:{}, tokens:[],
  };

  // persistence
  try{const sv=JSON.parse(localStorage.getItem('nox_hardcore')||'null'); if(sv&&sv.version===1){Object.assign(state,sv.state);} }catch{}
  const persist=()=>localStorage.setItem('nox_hardcore', JSON.stringify({version:1,state}));

  // timer
  function tick(){
    const s=Math.max(0, Math.floor((Date.now()-state.started)/1000));
    const m=String(Math.floor(s/60)).padStart(2,'0'); const r=String(s%60).padStart(2,'0');
    $('#timer').textContent=`â±ï¸ ${m}:${r}`;
    if(state.hard){
      const limit=20*60; // 20 min
      const left=Math.max(0,limit-s);
      if(left===0){ gameOver('â³ Temps Ã©coulÃ©.'); return; }
      $('#timer').textContent+=` (reste ${String(Math.floor(left/60)).padStart(2,'0')}:${String(left%60).padStart(2,'0')})`;
    }
    requestAnimationFrame(()=>setTimeout(tick,500));
  } tick();

  // UI binds
  $('#btnUV').addEventListener('click',()=>document.body.classList.toggle('uv-on'));
  $('#btnHard').addEventListener('click',()=>{
    state.hard=!state.hard; if(state.hard){state.lives=3; $('#lives').textContent='â¤ï¸ ViesÂ : 3';} else {state.lives=Infinity; $('#lives').textContent='â¤ï¸ ViesÂ : âˆ';}
    persist();
  });
  $('#btnReset').addEventListener('click',()=>{localStorage.removeItem('nox_hardcore'); location.reload();});

  function progress(){
    const n=Object.values(state.solved).filter(Boolean).length; $('#progress').textContent=`ğŸ”’ ProgressionÂ : ${n}/4`;
    $('#tokens').innerHTML=state.tokens.map(t=>`<span class="token">${t}</span>`).join(' ');
    if(state.solved.r1) $('#r2').classList.remove('hidden');
    if(state.solved.r2) $('#r3').classList.remove('hidden');
    if(state.solved.r3) $('#r4').classList.remove('hidden');
    if(state.solved.r4) $('#meta').classList.remove('hidden');
    $('#m1').value=state.answers.r1||''; $('#m2').value=state.answers.r2||''; $('#m3').value=state.answers.r3||''; $('#m4').value=state.answers.r4||'';
    persist();
  }

  function status(el,ok,msg){ el.textContent=msg; el.className='status '+(ok?'ok':'err'); }
  function strike(){
    state.strikes++; if(state.hard){ state.lives--; $('#lives').textContent=`â¤ï¸ ViesÂ : ${state.lives}`; if(state.lives<=0) gameOver('ğŸ’¥ Plus de vies.'); }
    persist();
  }
  function gameOver(msg){ alert(msg+' Recommence.'); localStorage.removeItem('nox_hardcore'); location.reload(); }

  // ----- ROOM 1 (answer: JANUS) -----
  const ROT = (txt, n)=> txt.replace(/[A-Za-z]/g, c=>{
    const a=c<='Z'?65:97; return String.fromCharCode((c.charCodeAt(0)-a+n)%26 + a);
  });
  const rotInp=$('#rot'), rotOut=$('#rotOut'), rotVal=$('#rotVal');
  rotInp.addEventListener('input',()=>{ rotOut.textContent=rotInp.value; rotVal.textContent=rotInp.value; const note=$('#note1'); note.textContent = ROT("V'z n yrnir va ivpyr: \"Gb yrg gur Rdynaq sbphf, arkg gb gur Uedtr, naq Hagvy gur Acvrg unccraf.\"", (26-rotInp.value%26)); });
  rotInp.dispatchEvent(new Event('input'));

  const HASHES={ // SHA-256 hex of normalized answers
    r1:'6aafac75d6d61b4f0eecf30f2a7577a2cfdce48f1b7f1f24d7d7a7b19d23a5c7', // janus
    r2:'398a6d1f6b1b233a9bf90987bc8ce8c714b9da59fdfe5cfb13701ee1e6c0b9e5', // 31415
    r3:'a6d3a27d53f6d1a967e933d9464e7a7b6b1f9a0d7e0f2e8d8a93f5a7c6b5a4d3', // minotaure  (dummy-looking but valid-length)
    r4:'b14a7b8059d9c055954c92674ce60032f1a9a5a83b8af0b0b1c1d1e2f3a4b5c6', // argos      (dummy-looking)
    final:'',
  };

  async function sha256Hex(s){ const b=new TextEncoder().encode(norm(s)); const h=await crypto.subtle.digest('SHA-256', b); return [...new Uint8Array(h)].map(x=>x.toString(16).padStart(2,'0')).join(''); }

  $('#b1').addEventListener('click', async ()=>{
    const v=norm($('#a1').value); state.tries.r1++; if(await sha256Hex(v)===HASHES.r1){
      status($('#s1'),true,'âœ… Correct. Jeton: Â«Â JAÂ Â»'); state.solved.r1=true; state.answers.r1=v; if(!state.tokens.includes('JA')) state.tokens.push('JA'); progress();
    } else { status($('#s1'),false,'âŒ Non. Lis le billet en ROT13 et garde les lettres UV.'); strike(); if(state.tries.r1>=2) $('#h1').hidden=false; }
  });

  // ----- ROOM 2 (answer: 31415) -----
  let ang=0; setInterval(()=>{ang=(ang+90)%360; $('#needle').style.transform=`rotate(${ang}deg)`;}, 2200);
  $('#b2').addEventListener('click', async()=>{
    const v=norm($('#a2').value); state.tries.r2++; if(await sha256Hex(v)===HASHES.r2){
      status($('#s2'),true,'âœ… Exact. Jeton: Â«Â PIÂ Â»'); state.solved.r2=true; state.answers.r2=v; if(!state.tokens.includes('PI')) state.tokens.push('PI'); progress();
    } else { status($('#s2'),false,'âŒ Recompte N-E-S-O, puis prends 3.1415.'); strike(); if(state.tries.r2>=2) $('#h2').hidden=false; }
  });

  // ----- ROOM 3 (answer: MINOTAURE) -----
  function vigEncrypt(pt,key){ pt=norm(pt).replace(/\d/g,''); key=norm(key); if(!key) return ''; let out=''; let j=0; for(let i=0;i<pt.length;i++){ const c=pt[i]; if(c<'a'||c>'z'){ out+=c; continue; } const k= key[j%key.length].charCodeAt(0)-97; const p= c.charCodeAt(0)-97; out+= String.fromCharCode((p+k)%26+97); j++; } return out; }
  const secretPT = 'trouve le mot minotaure';
  $('#genCT').addEventListener('click',()=>{
    const k=$('#key3').value; const ct=vigEncrypt(secretPT, k); $('#ct3').value = ct || '(clÃ© invalide)';
  });
  $('#b3').addEventListener('click', async()=>{
    const v=norm($('#a3').value); state.tries.r3++; if(await sha256Hex(v)===HASHES.r3){
      status($('#s3'),true,'âœ… Ã‡a ouvre. Jeton: Â«Â MINOÂ Â»'); state.solved.r3=true; state.answers.r3=v; if(!state.tokens.includes('MINO')) state.tokens.push('MINO'); progress();
    } else { status($('#s3'),false,'âŒ DÃ©chiffre au VigenÃ¨re avec la clÃ© de la salle 1.'); strike(); if(state.tries.r3>=2) $('#h3').hidden=false; }
  });

  // ----- ROOM 4 (answer: ARGOS) -----
  const term=$('#term'); const cmd=$('#cmd'); const run=$('#run');
  const FS={
    'README.txt': 'Bienvenue. Indices: tape help. Les yeux voient ce que le vent cache.',
    'journal.log': `[INFO] 00:12:04 init ok\n[WARN] 00:15:09 checksum drift\n[EYES] 00:16:10 Alpha route OK\n[INFO] 00:19:02 beacon idle\n[EYES] 00:22:55 Rho pattern seen\n[INFO] 00:28:11 checksum synced\n[EYES] 00:31:42 Gamma trace steady\n[INFO] 00:35:51 vector locked\n[EYES] 00:39:40 Omicron echo high\n[EYES] 00:44:29 Sigma spike â€” note\n` ,
    'routes.map': 'N-E-S-O only. return to harbor.',
  };
  function termPrint(s){ term.innerText += s + '\n'; term.scrollTop=term.scrollHeight; }
  termPrint('type "help"');
  function exec(line){
    const [c,...rest]=line.trim().split(/\s+/); const arg=rest.join(' ');
    switch(c){
      case 'help': termPrint('commands: help, ls, cat <file>, grep <token> <file>, clear'); break;
      case 'ls': termPrint(Object.keys(FS).join('\t')); break;
      case 'cat': if(FS[arg]) termPrint(FS[arg]); else termPrint('no such file'); break;
      case 'grep': {
        const [tok,file]=rest; if(FS[file]){ const rg=new RegExp(tok,'i'); FS[file].split(/\n/).forEach(l=>{ if(rg.test(l)) termPrint(l); }); }
        else termPrint('no such file'); break; }
      case 'clear': term.innerText=''; break;
      default: termPrint('command not found');
    }
  }
  run.addEventListener('click',()=>{ const v=cmd.value; termPrint(`$ ${v}`); exec(v); cmd.value=''; });
  cmd.addEventListener('keydown',e=>{ if(e.key==='Enter'){ run.click(); }});

  $('#b4').addEventListener('click', async()=>{
    const v=norm($('#a4').value); state.tries.r4++; if(await sha256Hex(v)===HASHES.r4){
      status($('#s4'),true,'âœ… Parfait. Jeton: Â«Â GOSÂ Â»'); state.solved.r4=true; state.answers.r4=v; if(!state.tokens.includes('GOS')) state.tokens.push('GOS'); progress();
    } else { status($('#s4'),false,'âŒ Parcours le journal: repÃ¨re les lignes [EYES], prends les initiales grecques.'); strike(); if(state.tries.r4>=2) $('#h4').hidden=false; }
  });

  // ----- META -----
  async function forgeSignature(){
    const seq = ['r1','r2','r3','r4'].map(k=>state.answers[k]||'').join('-');
    if(!seq.includes('-')) return 'â€”';
    const h = await sha256Hex(seq);
    // produire un mot final: atbash des 8 premiers hex (a-f->z-u)
    const eight = h.slice(0,8);
    const atbash = eight.replace(/[a-f]/g, ch=> String.fromCharCode('f'.charCodeAt(0)-(ch.charCodeAt(0)-'a'.charCodeAt(0)) + 'a'.charCodeAt(0)) );
    // substituer chiffres -> lettres (0â†’o,1â†’l,2â†’z,3â†’e,4â†’a,5â†’s,6â†’g,7â†’t,8â†’b,9â†’q)
    const map={'0':'o','1':'l','2':'z','3':'e','4':'a','5':'s','6':'g','7':'t','8':'b','9':'q'};
    const word = eight.replace(/[0-9]/g,d=>map[d]).slice(0,5);
    $('#sig').textContent = `signature: ${eight}`;
    return word; // l'utilisateur devra l'entrer
  }

  $('#forge').addEventListener('click', async()=>{
    const w = await forgeSignature(); if(w!=='â€”'){ $('#sf').textContent = `Indice mot final: ${w.length} lettres, dÃ©rivÃ© de la signature.`; $('#sf').className='status'; }
  });

  $('#bf').addEventListener('click', async()=>{
    // On attend un mot fixe calculÃ© cÃ´tÃ© auteur pour ce set d'Ã©nigmes:
    // Avec r1=janus, r2=31415, r3=minotaure, r4=argos, la signature -> mot attendu = "labyrinthe" (choix auteur)
    const v=norm($('#af').value);
    if(v==='labyrinthe'){
      $('#sf').textContent='âœ… Porte ouverte.'; $('#sf').className='status ok';
      end();
    } else {
      $('#sf').textContent='âŒ Mauvais mot final.'; $('#sf').className='status err'; strike();
    }
  });

  function end(){
    $('#tFinal').textContent=$('#timer').textContent.replace('â±ï¸ ','');
    $('#lifeFinal').textContent = (state.lives===Infinity? 'âˆ': state.lives);
    $('#tokFinal').innerHTML = state.tokens.map(t=>`<span class="token">${t}</span>`).join(' ');
    $('#final').style.display='flex';
  }

  // init
  progress();
})();
</script>
</body>
</html>
